<h1>Supporting reject state for promise created with trailing closure</h1>
<p>Nimbus currently has a way to turn a native method into Javascript method that returns a promise.  For example let's say that we have a method <code>foo</code> in iOS:</p>
<pre class="language-swift"><code class="language-swift"><span class="highlight-line"><span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span>@escaping callback<span class="token punctuation">:</span> <span class="token punctuation">(</span>success<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">Void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></span></code></pre>
<p>and a counterpart in Android:</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="highlight-line"><span class="token keyword">fun</span> <span class="token function">foo</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> <span class="token punctuation">(</span>success<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span></span></code></pre>
<p>For these two methods to be converted into a method that returns a promise in Javascript we need to bind <code>foo</code>, for iOS, and indicate that the closure that was passed as a parameter is for promise:</p>
<pre class="language-swift"><code class="language-swift"><span class="highlight-line">connection<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> trailingClosure<span class="token punctuation">:</span> <span class="token punctuation">.</span>promise<span class="token punctuation">)</span></span></code></pre>
<p>And for Android we need to annotate <code>foo</code> with:</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="highlight-line"><span class="token annotation builtin">@ExtensionMethod</span><span class="token punctuation">(</span>trailingClosure <span class="token operator">=</span> TrailingClosure<span class="token punctuation">.</span>PROMISE<span class="token punctuation">)</span></span><br><span class="highlight-line">func <span class="token function">foo</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> <span class="token punctuation">(</span>success<span class="token operator">:</span>String<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span></span></code></pre>
<p>In Javascript the above would translate into code like this:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></code></pre>
<p>But because this promise currently only supports the resolve state but not the reject state it is only then-able:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token comment">// Doable:</span></span><br><span class="highlight-line"><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token comment">// Not doable:</span></span><br><span class="highlight-line"><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token comment">// Also not doable:</span></span><br><span class="highlight-line"><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span></code></pre>
<p>This RFC lists and explores 3 distinct approaches to support reject state in Nimbus.</p>
<p><strong>(1) Method that Throws</strong></p>
<p>If a method is declared to throw and is designated as a trailing closure,
in iOS:</p>
<pre class="language-swift"><code class="language-swift"><span class="highlight-line"><span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span>@escaping callback<span class="token punctuation">:</span> <span class="token punctuation">(</span>success<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></span><br><span class="highlight-line">connection<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> trailingClosure<span class="token punctuation">:</span> <span class="token punctuation">.</span>promise<span class="token punctuation">)</span></span></code></pre>
<p>in Android:</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="highlight-line"><span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token annotation builtin">@ExtensionMethod</span><span class="token punctuation">(</span>trailingClosure <span class="token operator">=</span> TrailingClosure<span class="token punctuation">.</span>PROMISE<span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token keyword">fun</span> <span class="token function">foo</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> <span class="token punctuation">(</span>success<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span></span></code></pre>
<p>then we can consider that promise for these methods will need to support both resolve and reject. All exceptions will be converted into 'something'(string message??).</p>
<p>Pro: Fairly easy to implement.<br>
Con: Exception thrown will lose information when it gets to Javascript as a string message. What type of data should reject state pass back??</p>
<p><strong>(2) Closure with Two Arguments</strong></p>
<p>If a method is passed a closure with two arguments and this closure is indicated as promise
in iOS:</p>
<pre class="language-swift"><code class="language-swift"><span class="highlight-line"><span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span>@escaping callback<span class="token punctuation">:</span> <span class="token punctuation">(</span>success<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token operator">?</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></span><br><span class="highlight-line">connection<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> trailingClosure<span class="token punctuation">:</span> <span class="token punctuation">.</span>promise<span class="token punctuation">)</span></span></code></pre>
<p>in Android:</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="highlight-line"><span class="token annotation builtin">@ExtensionMethod</span><span class="token punctuation">(</span>trailingClosure <span class="token operator">=</span> TrailingClosure<span class="token punctuation">.</span>PROMISE<span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token keyword">fun</span> <span class="token function">foo</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> <span class="token punctuation">(</span>success<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span> error<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span></span></code></pre>
<p>then we can use this same closure to callback for both resolved and rejected states.  The distinction for the two states are made by one of the arguments to the closure being a null but not both.</p>
<p>Pro: Fairly easy to implement.<br>
Con: Should the type for error parameter be constrained to specific type???</p>
<p><strong>(3) Second Closure As Parameter</strong></p>
<p>If a method is passed <strong>two</strong> closures and these closures are marked for the promise's resolve and reject callbacks,
in iOS:</p>
<pre class="language-swift"><code class="language-swift"><span class="highlight-line"><span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span>@escaping success<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> @escaping error<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></span><br><span class="highlight-line">connection<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> trailingClosure<span class="token punctuation">:</span> <span class="token punctuation">.</span>promiseResolveAndReject<span class="token punctuation">)</span></span></code></pre>
<p>in Android:</p>
<pre class="language-kotlin"><code class="language-kotlin"><span class="highlight-line"><span class="token annotation builtin">@ExtensionMethod</span><span class="token punctuation">(</span>trailingClosure <span class="token operator">=</span> TrailingClosure<span class="token punctuation">.</span>PROMISE_RESOLVE_AND_REJECT<span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token keyword">fun</span> <span class="token function">foo</span><span class="token punctuation">(</span>success<span class="token operator">:</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">,</span> error<span class="token operator">:</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">}</span></span></code></pre>
<p>then we can use respective closure to notify resolve and reject states.</p>
<p>Pro: Easier to read than the previous 2 approaches.<br>
Con: More code to write than the previous 2 approaches.</p>
